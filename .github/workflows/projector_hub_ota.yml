name: Aku Platform Mesh Device OTA Package (GCP)

on:
  push:
    branches: [main]

jobs:
  build-package-ota:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
      OTA_BUCKET: ${{ secrets.GCP_OTA_BUCKET }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd projector_sync_service
          pip install -r requirements.txt

      - name: Build Sync Agent
        run: |
          cd projector_sync_service
          python main.py --check

      - name: Build PWA
        run: |
          cd ../frontend
          npm install
          npm run build

      - name: Package OTA Update
        run: |
          mkdir -p ota_package
          cp -r projector_sync_service ota_package/
          cp -r frontend/dist ota_package/pwa
          cp deployment/nginx.conf ota_package/
          # Add AI models, scripts, and other mesh device components as needed

      - name: Deployment Readiness Check
        run: |
          test -f ota_package/pwa/index.html
          test -f ota_package/projector_sync_service/main.py
          # Add checks for other mesh device components as needed

      - name: Upload OTA Package to GCP Storage
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          credentials: ${{ secrets.GCP_SA_KEY }}
          bucket: ${{ secrets.GCP_OTA_BUCKET }}
          source: ota_package/**
          destination: ota_updates/${{ github.sha }}/
