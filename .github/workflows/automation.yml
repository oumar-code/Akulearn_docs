name: Akulearn Automation
on:
  schedule:
    - cron: '0 2 * * *' # Nightly automation
  workflow_dispatch: # Allow manual trigger
jobs:
  main-worktree-health:
    name: Main Worktree Health Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout main worktree (full history)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Verify main worktree integrity
        run: |
          echo "=== Main Worktree Health Check ==="
          echo "Branch : $(git rev-parse --abbrev-ref HEAD)"
          echo "Commit : $(git rev-parse --short HEAD)"
          echo "Date   : $(git log -1 --format='%ci')"
          echo ""
          echo "=== Recent Activity (last 7 days) ==="
          git log --oneline --since="7 days ago" || echo "(no commits in last 7 days)"
          echo ""
          echo "=== Worktree List ==="
          git worktree list
          echo ""
          echo "✓ Main worktree integrity check passed"

      - name: Check for unmerged feature branches
        run: |
          echo "=== Branches not yet merged into main ==="
          git branch -r --no-merged origin/main | grep -v 'HEAD' || echo "(all remote branches are merged)"

      - name: Validate key project files
        run: |
          echo "=== Validating key project files ==="
          for f in mkdocs.yml requirements.txt README.md; do
            if [ -f "$f" ]; then
              echo "✓ $f exists"
            else
              echo "✗ $f MISSING" && exit 1
            fi
          done

      - name: Workflow file audit
        run: |
          echo "=== GitHub Actions workflows in main ==="
          ls -1 .github/workflows/*.yml | wc -l | xargs -I{} echo "{} workflow files found"
          ls -1 .github/workflows/*.yml
