name: Demo Visualization CI

on:
  push:
    branches: [ main, docs-copilot-refactor ]
    paths:
      - 'mlops/demo_visualizations.py'
      - 'mlops/exam_content_demo.ipynb'
      - 'mlops/test_imports.py'
      - 'requirements.txt'
      - '.github/workflows/demo-ci.yml'
  pull_request:
    branches: [ main ]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy plotly kaleido
        
    - name: Create runs directory
      run: mkdir -p runs
        
    - name: Run import test
      run: |
        python mlops/test_imports.py
    
    - name: Run demo visualization script
      run: |
        python mlops/demo_visualizations.py
    
    - name: Verify outputs created
      run: |
        test -f runs/exam_content_batch.json || (echo "Missing exam_content_batch.json" && exit 1)
        test -f runs/content_generation_stats.json || (echo "Missing content_generation_stats.json" && exit 1)
        test -f runs/chart_1_exam_board_distribution.html || (echo "Missing chart output" && exit 1)
        echo "✓ All demo outputs created successfully"
    
    - name: Upload demo outputs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: demo-visualizations
        path: runs/
        retention-days: 7

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install flake8
      run: pip install flake8
    
    - name: Lint mlops scripts
      run: |
        # Check for obvious syntax errors in key files
        python -m py_compile mlops/demo_visualizations.py
        python -m py_compile mlops/test_imports.py
        echo "✓ Syntax check passed"